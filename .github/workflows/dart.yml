name: CI/CD M贸vil - Aplicaci贸n Flutter

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  analizar-y-probar:
    name: Calidad de C贸digo y Pruebas
    runs-on: ubuntu-latest
    timeout-minutes: 15  

    steps:
      - name: Obtener c贸digo del repositorio
        uses: actions/checkout@v4

      - name: Configurar Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'  

      - name: Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-:hash:'  
          cache-path: '${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:'

      - name: Obtener versi贸n de Flutter
        run: flutter --version

      - name: Instalar dependencias
        run: flutter pub get

      - name: Verificar dependencias desactualizadas
        run: flutter pub outdated
        continue-on-error: true  

      - name: Ejecutar analizador de Flutter
        run: flutter analyze --no-fatal-infos 
        continue-on-error: false

      - name: Verificar formato de c贸digo
        run: dart format --set-exit-if-changed .
        continue-on-error: false
        
      - name: Ejecutar pruebas unitarias e integracion
        run: flutter test --concurrency=4  
        continue-on-error: false

  versionado:
    name: Versionado Autom谩tico
    runs-on: ubuntu-latest
    needs: analizar-y-probar
    timeout-minutes: 5  
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      version_number: ${{ steps.bump.outputs.version_number }}
      build_number: ${{ steps.bump.outputs.build_number }}

    steps:
      - name: Obtener c贸digo del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Obtener 煤ltima versi贸n
        id: get_version
        run: |
          LAST_TAG=$(git tag -l "v*" | sort -V | tail -n 1)
          if [ -z "$LAST_TAG" ]; then
            echo "last_version=v0.0.0" >> $GITHUB_OUTPUT
          else
            echo "last_version=$LAST_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Incrementar versi贸n
        id: bump
        run: |
          LAST_VERSION="${{ steps.get_version.outputs.last_version }}"
          VERSION_NUMBER=$(echo $LAST_VERSION | sed 's/v//' | sed 's/\./ /g')
          MAJOR=$(echo $VERSION_NUMBER | awk '{print $1}')
          MINOR=$(echo $VERSION_NUMBER | awk '{print $2}')
          NEW_MINOR=$((MINOR + 1))
          NEW_VERSION="v${MAJOR}.${NEW_MINOR}.0"
          VERSION_NUM="${MAJOR}.${NEW_MINOR}.0"
          BUILD_NUM=$((MAJOR * 10000 + NEW_MINOR * 100 + 0))
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_number=$VERSION_NUM" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUM" >> $GITHUB_OUTPUT

      - name: Crear etiqueta de versi贸n
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$NEW_VERSION" -m "Versi贸n autom谩tica $NEW_VERSION"
          git push origin "$NEW_VERSION"

  compilar-android:
    name: Compilar APK de Android
    runs-on: ubuntu-latest
    needs: [analizar-y-probar, versionado]
    timeout-minutes: 30  

    steps:
      - name: Obtener c贸digo del repositorio
        uses: actions/checkout@v4

      - name: Configurar Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'  

      - name: Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-:hash:'  
          cache-path: '${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:'

      - name: Decodificar archivo Firebase
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > android/app/google-services.json

      - name: Instalar dependencias
        run: flutter pub get

      - name: Actualizar versi贸n en pubspec.yaml
        run: |
          VERSION="${{ needs.versionado.outputs.version_number }}"
          BUILD="${{ needs.versionado.outputs.build_number }}"
          sed -i "s/^version: .*/version: ${VERSION}+${BUILD}/" pubspec.yaml

      - name: Restaurar keystore desde Base64
        run: |
          mkdir -p android/app/keystore
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/keystore/sututeh-release.jks

      - name: Configurar variables de firma
        run: |
          cat <<EOF > android/key.properties
          storeFile=keystore/sututeh-release.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF

      - name: Compilar APK (release)
        run: flutter build apk --release --build-name=${{ needs.versionado.outputs.version_number }} --build-number=${{ needs.versionado.outputs.build_number }} --split-per-abi  #  Split por ABI para APKs m谩s peque帽os

      - name: Compilar APK (debug)
        run: flutter build apk --debug --build-name=${{ needs.versionado.outputs.version_number }} --build-number=${{ needs.versionado.outputs.build_number }}

      - name: Renombrar APKs
        run: |
          VERSION="${{ needs.versionado.outputs.version_number }}"
          cd build/app/outputs/flutter-apk/
          # Si existe app-release.apk, renombrarla
          [ -f app-release.apk ] && mv app-release.apk sututeh-${VERSION}-release.apk || true
          # Si hay APKs split, renombrar el arm64-v8a (el m谩s com煤n)
          [ -f app-arm64-v8a-release.apk ] && mv app-arm64-v8a-release.apk sututeh-${VERSION}-release.apk || true
          mv app-debug.apk sututeh-${VERSION}-debug.apk
          ls -lh

      - name: Subir artefactos
        uses: actions/upload-artifact@v4
        with:
          name: sututeh-${{ needs.versionado.outputs.version_number }}-release
          path: build/app/outputs/flutter-apk/sututeh-${{ needs.versionado.outputs.version_number }}-release.apk
          retention-days: 30
          compression-level: 0  

  crear-release:
    name: Crear Release en GitHub
    runs-on: ubuntu-latest
    needs: [versionado, compilar-android]
    timeout-minutes: 5  

    steps:
      - name: Obtener c贸digo del repositorio
        uses: actions/checkout@v4

      - name: Descargar APK generado
        uses: actions/download-artifact@v4
        with:
          name: sututeh-${{ needs.versionado.outputs.version_number }}-release
          path: ./artifacts/

      - name: Crear Release en GitHub
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.versionado.outputs.new_version }}
          name: SUTUTEH App ${{ needs.versionado.outputs.new_version }}
          body: |
            ##  SUTUTEH Mobile App - Release ${{ needs.versionado.outputs.new_version }}

            **Versi贸n:** ${{ needs.versionado.outputs.version_number }}
            **Build:** ${{ needs.versionado.outputs.build_number }}
            **Fecha:** ${{ github.event.head_commit.timestamp }}

            ###  Archivos
            - APK de producci贸n listo para instalaci贸n manual
          files: ./artifacts/sututeh-${{ needs.versionado.outputs.version_number }}-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
